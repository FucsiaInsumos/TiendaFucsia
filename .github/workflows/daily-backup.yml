name: ğŸ›¡ï¸ Daily Database Backup

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 2:00 AM UTC (10:00 PM Colombia)
    - cron: '0 2 * * *'
  workflow_dispatch: # Permitir ejecuciÃ³n manual
    inputs:
      backup_type:
        description: 'Tipo de backup'
        required: false
        default: 'daily'
        type: choice
        options:
          - daily
          - manual
          - pre-deploy
      reason:
        description: 'RazÃ³n del backup'
        required: false
        default: 'manual_github'

jobs:
  backup:
    name: ğŸ“¦ Crear Backup de Base de Datos
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: BackFucsia/package-lock.json
        
    - name: ğŸ˜ Install PostgreSQL client
      run: |
        sudo apt-get update
        # Instalar el cliente PostgreSQL correcto para Ubuntu 24.04
        sudo apt-get install -y postgresql-client
        # Verificar instalaciÃ³n
        pg_dump --version
        
    - name: ğŸ“ Create backup directories
      run: |
        mkdir -p BackFucsia/backups/daily
        mkdir -p BackFucsia/backups/manual
        mkdir -p BackFucsia/backups/weekly
        mkdir -p BackFucsia/backups/pre-deploy
        
    - name: ğŸ“¦ Install dependencies
      working-directory: ./BackFucsia
      run: |
        npm ci --only=production
        
    - name: ğŸ›¡ï¸ Create database backup
      working-directory: ./BackFucsia
      env:
        DB_DEPLOY: ${{ secrets.DB_DEPLOY }}
        RETENTION_DAYS: 30
      run: |
        # Determinar tipo de backup y razÃ³n
        BACKUP_TYPE="${{ github.event.inputs.backup_type || 'daily' }}"
        REASON="${{ github.event.inputs.reason || 'github_action' }}"
        
        echo "ğŸ”„ Iniciando backup tipo: $BACKUP_TYPE"
        echo "ğŸ“ RazÃ³n: $REASON"
        
        # Verificar que DB_DEPLOY estÃ¡ configurado
        if [ -z "$DB_DEPLOY" ]; then
          echo "âŒ Error: DB_DEPLOY no estÃ¡ configurado en secrets"
          exit 1
        fi
        
        echo "âœ… Variable DB_DEPLOY configurada"
        
        # Ejecutar script de backup
        node scripts/railway-backup.js "$BACKUP_TYPE" "$REASON"
        
    - name: ğŸ“Š List created backups
      working-directory: ./BackFucsia
      run: |
        echo "ğŸ“‹ Backups creados:"
        find backups -name "*.dump" -exec ls -lh {} \; | tail -5
        echo ""
        echo "ğŸ“Š Espacio total usado por backups:"
        du -sh backups/* 2>/dev/null || echo "No hay backups aÃºn"
        
    - name: ğŸš€ Upload backup artifacts
      uses: actions/upload-artifact@v4
      with:
        name: database-backup-${{ github.run_number }}
        path: |
          BackFucsia/backups/daily/
          BackFucsia/backups/manual/
          BackFucsia/backups/pre-deploy/
        retention-days: 30
        compression-level: 9
        if-no-files-found: warn
        
    - name: ğŸ“§ Notify backup status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Backup completado exitosamente"
          echo "ğŸ“Š InformaciÃ³n del backup:"
          echo "- Tiempo: $(date)"
          echo "- Tipo: ${{ github.event.inputs.backup_type || 'daily' }}"
          echo "- RazÃ³n: ${{ github.event.inputs.reason || 'github_action' }}"
          echo "- Run ID: ${{ github.run_number }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
        else
          echo "âŒ Error en backup"
          echo "ğŸ” Revisa los logs para mÃ¡s detalles"
          echo "ğŸ’¡ Verifica que DB_DEPLOY estÃ© configurado en los secrets"
        fi

  notify-completion:
    name: ğŸ“¬ NotificaciÃ³n de Backup
    runs-on: ubuntu-latest
    needs: backup
    if: always()
    
    steps:
    - name: ğŸ“¨ Send completion notification
      run: |
        if [ "${{ needs.backup.result }}" == "success" ]; then
          echo "ğŸ‰ Backup diario completado exitosamente"
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ”— Puedes descargar el backup desde la pestaÃ±a Actions"
        else
          echo "âš ï¸ Hubo un problema con el backup diario"
          echo "ğŸ”§ Se requiere atenciÃ³n manual"
        fi