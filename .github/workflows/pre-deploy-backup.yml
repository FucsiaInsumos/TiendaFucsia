name: ğŸš€ Pre-Deploy Backup

on:
  workflow_dispatch:
    inputs:
      deploy_description:
        description: 'DescripciÃ³n del deploy'
        required: true
        default: 'Deploy de nuevas funcionalidades'
      environment:
        description: 'Ambiente de deploy'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  pre-deploy-backup:
    name: ğŸ“¦ Backup Pre-Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: BackFucsia/package-lock.json
        
    - name: ğŸ˜ Install PostgreSQL client
      run: |
        sudo apt-get update
        # Instalar el cliente PostgreSQL correcto para Ubuntu 24.04
        sudo apt-get install -y postgresql-client
        # Verificar instalaciÃ³n
        pg_dump --version
        
    - name: ğŸ“ Create backup directories
      run: |
        mkdir -p BackFucsia/backups/pre-deploy
        
    - name: ğŸ“¦ Install dependencies
      working-directory: ./BackFucsia
      run: |
        npm ci --only=production
        
    - name: ğŸ›¡ï¸ Create pre-deploy backup
      working-directory: ./BackFucsia
      env:
        DB_DEPLOY: ${{ secrets.DB_DEPLOY }}
        RETENTION_DAYS: 90
      run: |
        DEPLOY_DATE=$(date +%Y%m%d_%H%M%S)
        REASON="pre_deploy_${DEPLOY_DATE}"
        
        echo "ğŸš€ Creando backup pre-deploy..."
        echo "ğŸ“ DescripciÃ³n: ${{ github.event.inputs.deploy_description }}"
        echo "ğŸŒ Ambiente: ${{ github.event.inputs.environment }}"
        echo "ğŸ“… Fecha: $DEPLOY_DATE"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        
        # Verificar que DB_DEPLOY estÃ¡ configurado
        if [ -z "$DB_DEPLOY" ]; then
          echo "âŒ Error: DB_DEPLOY no estÃ¡ configurado en secrets"
          exit 1
        fi
        
        echo "âœ… Variable DB_DEPLOY configurada"
        
        # Ejecutar backup pre-deploy
        node scripts/railway-backup.js pre-deploy "$REASON"
        
        # Crear archivo con informaciÃ³n del deploy
        echo "ğŸš€ DEPLOY INFORMATION" > "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "==============================================" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸ“… Date: $(date)" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸ“ Description: ${{ github.event.inputs.deploy_description }}" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸ”— Commit SHA: ${{ github.sha }}" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸ“¦ Run Number: ${{ github.run_number }}" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        echo "ğŸ” Run ID: ${{ github.run_id }}" >> "backups/pre-deploy/deploy_info_${DEPLOY_DATE}.txt"
        
    - name: ğŸ“Š Verify backup creation
      working-directory: ./BackFucsia
      run: |
        echo "ğŸ“‹ Backups pre-deploy creados:"
        find backups/pre-deploy -name "*.dump" -exec ls -lh {} \; | tail -3
        echo ""
        echo "ğŸ“„ Archivos de informaciÃ³n:"
        find backups/pre-deploy -name "deploy_info_*.txt" -exec ls -lh {} \; | tail -1
        echo ""
        echo "ğŸ“Š Espacio total usado:"
        du -sh backups/pre-deploy/* 2>/dev/null || echo "Calculando tamaÃ±o..."
        
    - name: ğŸš€ Upload pre-deploy backup
      uses: actions/upload-artifact@v4
      with:
        name: pre-deploy-backup-${{ github.run_number }}
        path: BackFucsia/backups/pre-deploy/
        retention-days: 90
        compression-level: 9
        if-no-files-found: error
        
    - name: âœ… Backup completion summary
      if: success()
      run: |
        echo "ğŸ‰ Â¡Backup pre-deploy completado exitosamente!"
        echo ""
        echo "ğŸ“Š RESUMEN DEL BACKUP:"
        echo "======================"
        echo "ğŸ“ DescripciÃ³n: ${{ github.event.inputs.deploy_description }}"
        echo "ğŸŒ Ambiente: ${{ github.event.inputs.environment }}"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Ejecutado por: ${{ github.actor }}"
        echo ""
        echo "âœ… PRÃ“XIMOS PASOS:"
        echo "=================="
        echo "1. ğŸ“¦ Descarga el backup desde la pestaÃ±a 'Actions'"
        echo "2. ğŸš€ Procede con el deploy de forma segura"
        echo "3. ğŸ”„ Si hay problemas, usa este backup para restaurar"
        echo ""
        echo "ğŸ”— Link directo al artifact:"
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
    - name: âŒ Backup failure notification
      if: failure()
      run: |
        echo "ğŸ’¥ Error en la creaciÃ³n del backup pre-deploy"
        echo ""
        echo "ğŸ” POSIBLES CAUSAS:"
        echo "==================="
        echo "âŒ DB_DEPLOY no configurado correctamente"
        echo "âŒ Problemas de conectividad con la base de datos"
        echo "âŒ Falta el script railway-backup.js"
        echo "âŒ Dependencias no instaladas correctamente"
        echo ""
        echo "ğŸ› ï¸ SOLUCIONES:"
        echo "==============="
        echo "1. Verifica que DB_DEPLOY estÃ© en GitHub Secrets"
        echo "2. Revisa los logs anteriores para detalles del error"
        echo "3. Prueba el backup manualmente en local"
        echo ""
        echo "âš ï¸ NO HAGAS DEPLOY SIN UN BACKUP EXITOSO"